# Сравнение хранилищ данных на базе MongoDB и Postgres

## Схемы данных

### Reviews

Хранилище рецензий

| Название поля | Тип данных | Описание                          | Пример                               |
|---------------|------------|-----------------------------------|--------------------------------------|
| id            | UUID       | Уникальный идентификатор рецензии | 623618bb-9f58-4455-b9f2-62e75e8c848a |
| title         | text       | Заголовок рецензии                | Очень неплохое кино                  |
| body          | text       | текст рецензии                    | Очень длинный текст рецензии         |
| created_at    | DateTime   | Дата и время публикации           | 2024-04-05 00:51:17                  |
| author        | UUID       | UUID пользователя                 | 623618bb-9f58-4455-b9f2-62e75e8c848a |
| movie         | UUID       | UUID фильма                       | 623618bb-9f58-4455-b9f2-62e75e8c848a |

### Reviews_rating

Хранилище оценок на рецензии

| Название поля | Тип данных | Описание                                  | Пример                               |
|---------------|------------|-------------------------------------------|--------------------------------------|
| review        | UUID       | UUID рецензии                             | 623618bb-9f58-4455-b9f2-62e75e8c848a |
| rating        | int        | Оценка. 0 считается за дизлайк, 10 - лайк | 623618bb-9f58-4455-b9f2-62e75e8c848a |
| user          | UUID       | UUID пользователя                         | 4                                    |

### Movies_rating

Хранилище оценок на фильмы

| Название поля | Тип данных | Описание                                  | Пример                               |
|---------------|------------|-------------------------------------------|--------------------------------------|
| movie         | UUID       | UUID фильма                               | 623618bb-9f58-4455-b9f2-62e75e8c848a |
| rating        | int        | Оценка. 0 считается за дизлайк, 10 - лайк | 4                                    |
| user          | UUID       | UUID пользователя                         | 623618bb-9f58-4455-b9f2-62e75e8c848a |

### Bookmarks

Хранилище фильмов, который пользователя добавил в закладка

| Название поля | Тип данных | Описание            | Пример                                                                     |
|---------------|------------|---------------------|----------------------------------------------------------------------------|
| movies        | list[UUID] | Список uuid фильмов | 623618bb-9f58-4455-b9f2-62e75e8c848a, 623618bb-9f58-4455-b9f2-62e75e8c848a |
| user          | UUID       | UUID пользователя   | 623618bb-9f58-4455-b9f2-62e75e8c848a                                       |

## Подготовка и генерация данных

Для подготовки инфрастуктуры необходимо:

1. Установить зависимости

```
python -m pip install -r requirements.txt
```

2. Запустить docker-compose окружение

```
docker-compose up -d --build
```

3. Создать и заполнить ```.env``` файла на примере ```.env.example```

Для генерации датасетов для тестирования необходимо запустить скрипт генерации данных:

```
python data_generator.py
```

Результатом работы скрипта будут четыре датасета в формате csv:

- reviews.csv - Датасет с рецензиями
- bookmarks.csv - Датасет с закладками пользователя
- reviews_rating.csv - Датасет с оценками рецензий
- moviews_rating.csv - Датасет с оценками фильмов

## Тестирования производительности MongoDB

### Запись данных

Для тестирования записи данных необходимо запустить скрипт:

```
python mongo_inserter.py
```

В результате работы скрипта будет создана БД ugc_db, а так же четыре коллекции:

- reviews
- reviews_likes
- bookmarks
- movies_likes

В данные коллекции будут импортированы данных из подготовленных выше датасетов.

### Чтение данных

Для тестирования чтения данных, необходимо запустить скрипт:

```
python mongo_reader.py
```

В скрипте будут вызваны следующие методы:

- *get_user_bookmarks(**user_id**)* - получение все фильмов, которые находятся в закладках у пользователя **user_id**
- *get_movie_likes_count(**movie_id**)* - подсчет количества лайков у фильма **movie_id**
- *get_average_movies_rating()* - Список всех фильмов со средней оценкой
- *get_likes_by_user(**user_id**)* - Список всех фильмов, которым пользователь **user_id** поставил лайк (rating=10)

**Для корректной работы скрипта необходимо указать аргументы у всех функций, где это требуется ее сигнатурой.
Актуальные аргументы нужно взять из сформированных датасетов**

## Тестирование производительности Postgres

Для тестирования записи данных необходимо запустить скрипт:

```
python postgres_inserter.py
```

В результате работы скрипта будет создана БД ugc_db, а так же четыре таблицы:

- reviews
- reviews_likes
- bookmarks
- movies_likes

В данные таблицы будут импортированы данных из подготовленных выше датасетов.

### Чтение данных

Для тестирования чтения данных, необходимо запустить скрипт:

```
python postgres_reader.py
```

В скрипте будут вызваны следующие методы:

- *get_user_bookmarks(**user_id**)* - получение все фильмов, которые находятся в закладках у пользователя **user_id**
- *get_movie_likes_count(**movie_id**)* - подсчет количества лайков у фильма **movie_id**
- *get_average_movies_rating()* - Список всех фильмов со средней оценкой
- *get_likes_by_user(**user_id**)* - Список всех фильмов, которым пользователь **user_id** поставил лайк (rating=10)

**Для корректной работы скрипта необходимо указать аргументы у всех функций, где это требуется ее сигнатурой.
Актуальные аргументы нужно взять из сформированных датасетов**

## Сравнение производительности вставки и чтения данных Postgres и MongoDB

|                                                                     | Postgres         | Mongo            |
|---------------------------------------------------------------------|------------------|------------------|
| Вставка данных на примере датасета reviews                          | 30.937458 секунд | 14.913582 секунд |
| Получение все фильмов, которые находятся в закладках у пользователя | 0.007784 секунд  | 0.020644 секунд  |
| Подсчет количества лайков у фильма                                  | 0.179878 секунд  | 0.008377 секунд  |
| Список всех фильмов со средней оценкой                              | 0.052563 секунд  | 0.001690 секунд  |
| Список всех фильмов, которым пользователь поставил лайк             | 0.022199 секунд  | 0.001055 секунд  |

### Вывод

Пайплайны агрегации MongoDB показывают хорошие результаты в скорости обработки данных, что в купе с возможностью
хранения неструктурированных данных делает
MongoDB приоритетным выбором в качестве хранилища.